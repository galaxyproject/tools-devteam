<tool id="vcf2fasta" name="VCF to Fasta:" version="0.0.3">
  <description>generate fasta for each sample, reference sequence, and chromosomal copy</description>
  <macros>
      <import>macros.xml</import>
  </macros>
  <expand macro="requirements"></expand>
  <expand macro="stdio" />
  <command>
    #set $reference_fasta_filename = "localref.fa"
    #if str( $reference_source.reference_source_selector ) == "history":
      ln -s "${reference_source.ref_file}" "${reference_fasta_filename}" &amp;&amp;
    #else:
      #set $reference_fasta_filename = str( $reference_source.ref_file.fields.path )
    #end if
    vcf2fasta -f "${reference_fasta_filename}" 
    #if $default_ploidy:
      -P "${default_ploidy}" 
    #end if
    -p "vcf2fa_" "${input_vcf}" 
  </command>
  <inputs>
    <param format="vcf" name="input_vcf" type="data" label="Select VCF dataset to convert"/>
    <conditional name="reference_source">
       <param name="reference_source_selector" type="select" label="Choose the source for the reference genome">
         <option value="cached">Locally cached</option>
         <option value="history">History</option>
       </param>
       <when value="cached">
         <param name="ref_file" type="select" label="Select reference genome">
           <options from_data_table="fasta_indexes">
           </options>
           <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
         </param>
       </when>
       <when value="history"> 
         <param name="ref_file" type="data" format="fasta" label="Using reference file" />
       </when>
     </conditional>
     <param name="default_ploidy" type="integer" value="" optional="true" label="default ploidy" help="Set a default ploidy for samples which do not have information in the first record (2)" />
  </inputs>
  <outputs>
    <!-- "Outputs sample_seq:N.fa for each sample, reference sequence, and chromosomal copy N in [0,1... ploidy]." -->
    <collection name="vcf2fasta_list" type="list" label="${tool.name} on ${on_string} fasta">
        <discover_datasets pattern="vcf2fa_(?&lt;designation&gt;.*:\d+\.fasta)" ext="fasta" visible="True" />
    </collection>
  </outputs>
  <tests>
    <test>
      <param name="reference_source_selector" value="history" />
      <param name="input_vcf" value="vcflib-phix.vcf"/>
      <param name="default_ploidy" value="2" />
      <param name="ref_file" value="vcflib-test-genome-phix.fa" />
      <output_collection name="vcf2fasta_list" type="list">
        <element name="groupA_phiX174:0.fasta">
          <assert_contents>
            <has_text_matching expression="^identifier is l11\n$" />
          </assert_contents>
        </element>
        <element name="groupB_phiX174:0.fasta">
          <assert_contents>
            <has_text_matching expression="^identifier is l12\n$" />
          </assert_contents>
        </element>
      </output_collection>

    </test>
    </tests>
  <help>

Converts VCF dataset to tab-delimited format, using null string to replace empty values in the table.
Specifying "**Report data per sample**" (-g) will output one line per sample with genotype information.

----

Vcf2Fasta @IS_PART_OF_VCFLIB@
</help>
  <expand macro="citations" />
</tool>
